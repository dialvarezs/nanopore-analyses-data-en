Temas a abordar:
- Consideraciones al analizar datos con Nanopore
- Como realizar basecalling con datos provenenientes de Oxford nanopore
- Como realizar demultiplexación con datos provenenientes de Oxford nanopore


## Consideraciones al secuenciar con dispositivos de Oxford Nanopore

##### Equivalencias
1 Kb (kilobase) = 1.000 bases
1 Mb (megabase) = 1.000 Kb o 1.000.000 pb
1 Gb (gigabase) = 1.000 Mb o 1.000.000.000 pb

#### Cobertura y profundidad
El concepto de cobertura normalmente se utiliza para indicar la cantidad de veces que fue secuenciada la región objetivo, la cual puede ser un gen o incluso un genoma completo. Sin embargo, esto suele referirse a un conteo total de la información secuenciada y no necesariamente quiere decir que en cada posición de la región objetivo haya una cantidad determinada de lecturas cubriéndola.

Por ejemplo, hablar de una cobertura de 50x quiere decir que en promedio hay 50 lecturas cubriendo la región en cada posición. Si la región objetivo es de 10 Mb, eso quiere decir que la información total debe ser alrededor de 500 Mb.

Alternativamente, puede hablarse de profundidad, que generalmente se utiliza para referirse a la cantidad de lecturas en una posición específica (por ejemplo, en el caso de variantes se reporta la profundidad de la secuenciación para cada variante).

Por último, en algunos casos menos comunes el uso de cobertura puede referirse al porcentaje cubierto de la región objetivo. Esto en caso de que por alguna razón no haya sido posible secuenciar la región objetivo en su totalidad con la profundidad requerida para los análisis a realizar, o directamente que no haya ninguna lectura cubriendo la región.

El siguiente esquema muestra una descripción gráfica de lo explicado anteriormente, en la cual se pueden visualizar las lecturas asociadas a cada posición de la región objetivo, y también se puede visualizar una zona que no se encuentra cubierta por ninguna lectura.

![[coverage.png]]

Dependiendo del tipo de análisis que se quiera realizar y objetivo de éste (exploración / puesta a punto, investigación o clínico) pueden existir distintos requerimientos de cobertura. La precisión lograda para cada análisis con diferentes plataformas de secuenciación suele estar documentada por el fabricante o investigaciones previas.

Es importante determinar la profundidad requerida antes de realizar un experimento, ya que eso ayudará a decidir cuantas librerías secuenciar para llegar al objetivo. Igual es relevante considerar es la calidad de la información secuenciada, ya que se puede perder una cantidad relevante de información en etapas de control de calidad, lo que afectará la cobertura real.


#### Eficiencia de una celda
Las diferentes celdas de flujo disponibles de Oxford Nanopore entregan diferentes cantidades, por lo que es importante al diseñar un experimento, tomar en consideración la cantidad de gigabases disponibles a entregar por cada dispositivo.
- Flongle: Máximo througput de 2.8Gb, cuenta con 126 canales.
- MinION: Máximo throughput de 50Gb, con 512 canales. Nanopore indica que es adecuado para secuenciaciones de entre 10Gb a 20Gb.
- PromethION: Máximo throughput de 290Gb, con 10.700 canales.

En casa secuenciación se pierde un porcentaje importante de información al demultiplexar y al aplicar los filtros de calidad, lo cual también debe evaluarse al calcular la cantidad de muestras a secuenciar.

#### Contenido de una secuencia
Dependiendo el diseño del experimento, la secuencia generada puede contener distintos elementos.
- Primer: si es que se trata de un amplición que es amplificado por PCR.
- Barcode: si se trata de múltiples muestras en una sola secuenciación.
- Adaptador: en todos los casos.
La herramienta utilizada para basecalling y demultiplexación, generalmente puede quitar estos elementos de la secuencia, dejando sólo la región de interés.

![[amplicon.jpg]]

### Precisión de Oxford Nanopore

#### RAW Data
La precisión de una sola molécula es similar a la precisión de la lectura sin procesar, pero en el caso de las lecturas dúplex, combina los datos llamados base de la plantilla y las hebras complementarias de una sola molécula de ADN en una llamada base de mayor calidad. Los datos dúplex son capaces de entregar datos superiores a Q30 y lecturas perfectas de moléculas de ADN de decenas de kilobases de longitud.

Celda |Kit | Precisión raw data | Herramientas de analisis
------------ | ------------ | ------------ | ------------ 
R10.4.1 | SQK-LSK114 260pbs | 99,6% (Q24 simplex) | Basecalling sup en MinKNOW
R9.4.1  | SQK-LSK110 450bps       | 98,3% (Q18 simplex) | Basecalling sup en MinKNOW
R10.4.1 | SQK-LSK114 260pbs | 99,92% (Q31 duplex) | Duplex basecalling con Guppy

#### Consensos
Los consensos se logran mediante el ensamblaje de múltiples lecturas, lo que permite llegar a secuencias objetivo de alta calidad.

Celda |Precisión del consenso | Herramientas de analisis
------------ | ------------ | ------------ 
R9.4.1 | Q50 con 100x | Basecalling sup + ensamblaje con Flye + pulido con Medaka
R10*   | Q50 con 20x | Basecalling sup + ensamblaje con Flye + pulido con Medaka
R10*   | Q47 con 60x y 80Mb de N50 | Basecalling sup + ensamblaje con Flye + pulido con Medaka

#### Llamada de variantes (Variant calling)
 Tipo   | Celda | Profundidad | Precision | Herramienta
------------ | ------------ | ------------ | ------------  | ------------ 
SV    | R9.4.1  | 50X | 95.5 | EPI2ME workflow (LRA & cuteSV) 
SV    | R10.4.1 | 60X | 95 | EPI2ME workflow (LRA & cuteSV) 
SNP   | R9.4.1  | 50X | 99.8 / 99.9 | Clair3 / DeepVariant
SNP   | R10.4.1 | 60X | 99.9 | Clair3
Indel | R10.4.1 | 60X | 94 | Clair3

## EPI2ME
[Offical page](https://epi2me.nanoporetech.com/workflows)  _requiere autenticación_

EPI2ME es la plataforma de análisis de Oxford Nanopore, y tiene como gran ventaja contar con flujos de trabajos ya diseñados y listos para ser ejecutados, además de trabajar sobre la nube, es decir, permite que el usuario ejecute flujos de trabajo sin contar con los recursos suficientes en su equipo, ya que los programas se ejecutan en la nube y no en el equipo del usuario.

EPI2ME presenta una interfaz de fácil uso e intuitiva para el usuario, junto con videotutoriales de cada flujo de trabajo.

EPI2ME cuenta con diversos pipelines para diferentes análisis, se puede encontrar más información acerca de los flujos de trabajos disponibles [aquí](https://labs.epi2me.io/wfindex). Algunos de los flujos de trabajos disponibles se presentan a continuación:
- Procesamiento de RAW data y control de calidad
	- Basecalling y demultiplexación
	- Obtención de estadísticas básicas de datos de ARN y ADN (tamaño de las secuencias, puntaje de calidad, cantidad de data generada)
- Alineamientos:
	- Alineamiento de lecturas con el genoma humano (GRCh38)
	- Alineamiento de lecturas con referencia
- Variant Calling: 
	- Detección de variantes estructurales (inserciones, eliminaciones, duplicaciones)
- Otros flujos de trabajo:
	- Ensamblaje e identificación de SARS-CoV-2 con ARTIC
	- Ensamblaje y alineamiento de lecturas con referencia de Monkeypox (viruela del mono)
	- Identificación taxonómica de gen ARNr 16s con Blast

## Basecalling
Herramienta: Guppy

En la plataforma de secuenciación de Oxford Nanopore, se utilizan nanoporos mediante los cuales pasa una hebra de ADN. Cuando la molécula pasa a través de un poro, éste puede detectar alteraciones producidas por los iones de la molécula, las que son codificadas mediante una señal eléctrica que es registrada en el equipo computacional. Determinar cuál fue la secuencia de nucleótidos de la molécula que pasó por el poro requiere el uso de algoritmos computacionales complejos; este proceso es llamado **basecalling**.

![[MinION_GIF_01.webm]]

A lo largo del tiempo en el desarrollo de esta tecnología, se han introducido múltiples cambios para mejorar la precisión del reconocimiento de bases, tanto en lo que respecta a la química de las celdas de flujo como de software que hace el basecalling. Uno de los cambios más recientes es la introducción del nanoporo "R10", que posee dos lectores en lugar de uno, lo que ayuda a la resolución, especialmente de regiones homopoliméricas.

Guppy es la herramienta creada oficial por Oxford Nanopore para realizar el basecalling, la cual utiliza un algoritmo basado en redes neuronales que son entrenadas con conjuntos de datos mixtos, de ADN/ARN amplificado y nativo, y de múltiples organismos (plantas, animales, bacterias, virus). Guppy además contiene funciones para filtrar lecturas de baja calidad, reconocer y recortar adaptadores conocidos y estimar probabilidades de metilación.

#### Precisión del basecalling

Guppy cuenta con múltiples modelos con diferentes equilibrios entre precisión del basecalling y capacidad de cómputo requerida. Concretamente, los modelos disponibles son:

 Nombre                | Precisión | Requerimientos Computacionales                                                                                   
----------------------- | ----------------------- | -----------------------
 fast [`fast`]          | 96% (qscore mínimo de 8)       |                                                        
 high accuracy [`hac`]  | 97.8% (qscore mínimo de 9)         | entre 5 y 8 veces más intenso computacionalmente que fast 
 super accuracy [`sup`] | 98.3% (qscore mínimo de 10)        | 3 veces más intenso computacionalmente que high accuracy  

![[basecalling_models_Nov2021.jpeg]] 

Si bien es clara la ventaja de los modelos con mayor precisión, el tener mayores requerimientos de hardware limita su utilización a equipos que tienen mayor potencia o un tiempo de ejecución elevado. En particular, el modelo `sup` tiene un costo computacional tan alto que se hace inviable utilizarlo sin hardware dedicado (GPU).
Es posible realizar el basecalling en tiempo real mientras se secuencia la muestra (ya que MinKNOW trae Guppy integrado), sin embargo, solamente son seleccionables los modelos `fast` y `hac`, y en el caso de utilizar `hac` el proceso de basecalling puede continuar por múltiples días después de terminar el experimento si no se cuenta con el hardware apropiado.

A continuación se puede visualizar la cantidad de gigabases procesadas por hora con diferentes modelos y con diferentes secuenciadores con diferentes capacidades de cómputo.
![[speed_basecalling.png]]


#### Output de Secuenciación
Al secuenciar una muestra, MinKNOW genera múltiples archivos que incluyen la información secuenciada y archivos de registro.
Los archivos más revelantes son los `.fast5` que contienen las variaciones de tensión registradas por el poro a medida que la pasa la hebra de ADN. Estos archivos igualmente pueden contener la información del resultado del basecalling en caso de que haya sido habilitada la opción en MinKNOW.

Dentro del directorio de secuenciación pueden encontrarse otros archivos también:
- `barcode_alignment`: En caso de seleccionar la opción de basecalling y demultiplexación, este archivo guardará la información asociada a cada lectura y los barcode detectados.
- `final_summary`: Contiene información resumida de la secuenciación, como la celda de flujo y kit utilizados, cantidad de archivos procesados, entre otros.
-  `other_reports/`: Reportes con detalles técnicos de la secuenciación.
- `throughput`: Contiene la información por minuto de la cantidad de bases secuenciadas, cantidad de lecturas que se les ha hecho basecalling (tanto fail como pass).
- `fast5/`: Directorio que contiene los archivos fast5 obtenidos en la secuenciación.
- `fastq_pass/`: En caso de seleccionar la opción de basecalling, en este directorio se guardarán los archivos fastq de aquellas lecturas que cumplan los críterios de calidad mínimos (por defecto 4.000 lecturas por archivo).
- `fastq_fail/`: En caso de seleccionar la opción de basecalling, en este directorio se guardarán los archivos fastq de aquellas lecturas que no cumplan los criterios de calidad mínimos (por defecto 4.000 lecturas por archivo).


#### Uso de Guppy
Guppy es un software desarrollado para trabajar con datos de secuenciación obtenidos a través de las plataformas de Oxford Nanopore. Contiene un conjunto de funciones que comprenden basecalling, demultiplexación, alineamiento, filtros, entre otras. Guppy requiere co`mo mínimo 4 GB de RAM y adicionalmente 1 GB por cada hilo de ejecución, y recomienda 512 GB de almacenamiento (depende del volumen de datos secuenciado).

Para realizar el basecalling se utiliza el comando  `guppy_basecaller`, este comando requiere como argumentos básicos:
- directorio de entrada, donde se encuentran los archivos `FAST5` ( `--input_path`)
- directorio de salida (`--save_path`)
- modelo de celda utilizado (`--flowcell`) 
- modelo de kit utilizado (`--kit`)
- Archivo de configuración (`--config`)
	- Se puede indicar un archivo de configuración o indicar la celda y kit utilizado.

Por defecto, Guppy utilizará el modelo de basecalling de alta precisión (`hac`), y en caso de querer utilizar un modelo diferente, debe indicarse el nombre de la configuración asociada (`--config`). Se pueden listar las configuraciones disponibles ejecutando
```bash
guppy_basecaller --print_workflows
```

Este comando que mostrará una lista con las combinaciones de celdas y kits y sus modelos disponibles. Dentro de esta lista deberá buscarse la celda y el kit utilizados, y copiar el valor indicado en la columna `config_name` y cambiar el sufijo `hac` por el correspondiente al modelo a utilizar (por ejemplo `sup`). Al ejecutar Guppy con la opción `--config` ya no es necesario especificar los parámetros kit y celda.

Cabe destacar que Guppy elimina los adaptadores y divide los archivos en `fail` y `pass`, generando esta diferencia en base al `qscore` de corte indicado (cada modelo tiene un qscore de corte diferente).

Los siguientes dos ejemplos muestran la ejecución de basecalling. El primero, indicando el archivo de configuración (especificando usar el modelo sup) y el segundo indicando la celda y kit. Adicionalmente, el segundo contiene el parámetro `min_qscore`.
```bash
guppy_basecaller \
    --input_path <directorio_fast5> \
    --save_path <directorio_output> \
    --config dna_r9.4.1_450bps_sup \
    --recursive \
    --device 'auto' \
    --num_callers 16

guppy_basecaller \
    --input_path <directorio_fast5> \
    --save_path <directorio_output> \
    --kit SQK-LSK110\
    --flowcell FLO-MIN106 \
    --recursive \
    --device 'auto' \
    --num_callers 16
```

Se puede utilizar la opción `--min_qscore` para indicar cuál será el valor de corte mínimo para determinar que lecturas filtrar por baja calidad (`fail`). Cada modelo tiene diferente valor de corte:
- `fast`: Qscore mínimo de 8, es decir, 85% de precisión.
- `hac`: Qscore mínimo de 9, es decir, 87% de precisión.
- `sup`: Qscore mínimo de 10, es decir, 90% de precisión.

Un ejemplo cambiando el valor mínimo para realizar el filtro de calidad: 
```bash
guppy_basecaller \
    --input_path <directorio_fast5> \
    --save_path <directorio_output> \
    --config dna_r9.4.1_450bps_sup \
    --recursive \
    --device 'auto' \
    --num_callers 16
    --min_qscore 8
```

Los archivos de configuración disponibles se pueden visualizar con el comando `guppy_basecaller --print_workflows`

El basecalling entrega como resultado los siguientes elementos:
- `fail/`: Directorio que contiene todas las lecturas en formato fastq que no pasaron el filtro de calidad mínimo (por defecto 3000 lecturas por fastq).
- `pass/`: Directorio que contiene todas las lecturas en formato fastq que pasaron el filtro de calidad mínimo (por defecto 3000 lecturas por fastq).
- `*.log`: Archivos de registros de estado de lecturas durante el basecalling.
- `sequencing_summary.txt`: Archivo de registro donde por cada lectura se puede encontrar información como su puntaje de calidad, promedio y tamaño. Al ejecutar el comando de basecalling, se le puede indicar que se añada información extra, sobre los adaptadores o primers encontrados, entre otras.


_spoiler:_ Se pueden utilizar diferentes herramientas para ver la calidad de la secuenciación y la cantidad de datos obtenidos, como por ejemplo usar `seqkit`. Esto lo aprenderemos más adelante.
```
seqkit stats sequences.fastq
```

## Demultiplexación
Herramienta: Guppy
Herramientas alternativas: Cutadapt

Nanopore permite realizar librerías donde se agrupen múltiples muestras en una sola celda de flujo. La demultiplexación es el proceso que clasifica las lecturas basándose en los códigos de barra (barcode) detectados en la secuencia. Para esto es necesario indicarle que kit de barcodes se utilizó al preparar la librería. 

La demultiplexación entrega como resultado un directorio por cada barcode al que se le asignaron lecturas, y también un directorio que contiene aquellas lecturas que no lograron clasificarse.  Adicionalmente, se obtiene un archivo de registro con la información resumen de los códigos de barras que mejor coinciden para cada lectura (`barcoding_summary`).

Guppy por defecto clasifica una lectura cuando logra detectar al menos un barcode en la lectura (ya sea el trasero o el delantero). En caso de que se esté utilizando algún pipeline o software que requiera demultiplexar detectando ambos códigos de barra, se puede utilizar la opción `--require_barcode_both_ends`. Cabe destacar que esta opción disminuye significativamente el número de lecturas que se clasifican correctamente. (Esta opción solo es válida en aquellos kits que tengan barcode delantero y trasero).

![[amplicon.jpg]]

Se pueden indicar parámetros adicionales al comando, para que detecte adaptadores y primers, y se indique en los reportes el puntaje de alineamiento que tuvieron. También puede modificarse el valor de puntaje mínimo para clasificar las lecturas.

El siguiente ejemplo muestra la ejecución de una demultiplexación utilizando el kit EXP-NBD196.
```bash
guppy_barcoder \
    --input_path <path_to_fastq> \
    --save_path <outdir> \
    --barcode_kits EXP-NBD196 \
    --recursive \
    --worker_threads 4
```


Se puede utilizar el comando mencionado en la sección anterior (`seqkit stats` para visualizar la cantidad de información obtenida por cada barcode), pero también se puede utilizar el comando ` du -sh *`  para visualizar la cantidad de información almacena en gigabytes. Esto es muy útil cuando la demultiplexación entrega como resultado más de un archivo `fastq` por cada barcode (*Recordatorio:* Por defecto, Nanopore almacena hasta 4.000 secuencias por archivo `fastq`.) 
```
 du -sh * | sort -hr
```

Generalmente, se genera una cantidad grande de archivos `fastq` por cada barcode secuenciado, para facilitar análisis posteriores, se suele juntar toda la información perteneciente a un barcode en un solo archivo. Para esto se pueden utilizar diferentes comandos o herramientas, entre ellas el comando `cat`.
```bash
cat barcode01/*.fastq > barcode01.fastq
```

### Basecalling y demultiplexación en un solo paso
Se puede realizar el basecalling y demultplexación en un solo paso con el comando `guppy_basecaller` pasando el parámetro `barcode_kits` para indicar el kit de códigos de barra utilizado. 
```bash
guppy_basecaller \
	--input_path <directorio_fast5> \
    --save_path <directorio_output> \
    --config <config_file> \
    --recursive \
    --device 'cuda:0,1' \
    --num_callers 16 \
    --gpu_runners_per_device 4 \
    --chunks_per_runner 1664 \
    --barcode_kits <kit_barcoding>
```



_TAREA:_ Se desean secuenciar 88 muestras de 16s con Oxford Nanopore. ¿Cuántas muestras deben secuenciarse por celda?. Considere la siguiente información:
	- Los amplicones a secuenciar son de entre 1000 - 2000 pares de bases.
	- Se desea una cantidad de lecturas mínima de 200.000 por cada muestra
	- Habitualmente las secuenciaciones no salen balanceadas.
	- Se utilizará una celda con química 9.4.1

_TAREA:_ Se desea ensamblar el genoma del Pingüino Magallanico (`Spheniscus magellanicus`). Calcule la cantidad de Gb necesarias para obtener un ensamblaje exitoso. Considere la siguiente información:
	- Puede utilizar el buscador de NCBI para obtener información relevante. [NCBI genome list](https://www.ncbi.nlm.nih.gov/genome/browse/#!/overview/)
	- Se utilizará una celda con química 9.4.1

