Temas a abordar:
- Subcomandos de blast y como utilizarlos
- Formato outfmt6 como output
- Bases de datos NCBI
- Creación de bases de datos

Una de las aplicaciones más comunes de los alineamientos es la búsqueda de una o más secuencias en bases de datos, con el fin de encontrar secuencias similares que permitan inferir información respecto a la secuencia que estamos utilizando como consulta, lo que puede permitir por ejemplo:
- Identificar organismos presentes en una muestra, o identificar especies homólogas.
- Identificar contaminación dentro de una muestra.
- Ubicar dominios conocidos en una secuencia de proteínas de interés.
- Crear un árbol filogenético.

La herramienta más utilizada para este fin es BLAST+ (generalmente llamada simplemente blast), que es desarrollada por el National Center for Biotechnology Information (NCBI) y tiene la ventaja de que este organismo igualmente provee bases de datos preparadas que para distintos fines. Adicionalmente, NCBI provee algunas variantes de BLAST para casos específicos, como IgBLAST y Magic-BLAST. Existen alternativas a BLAST como Diamond o MMSeqs2 que tienen como ventaja tener un mejor rendimiento y/o proveer funciones adicionales.

#### BLAST (Basic local alignment search tool)
[Documentación](https://www.ncbi.nlm.nih.gov/books/NBK279690/) || [WebTool](https://blast.ncbi.nlm.nih.gov/Blast.cgi?PAGE_TYPE=BlastSearch)

BLAST compara secuencias objetivos (querys) contra una base de datos de referencias (subject). El algoritmo se basa en la búsqueda de coincidencias pequeñas entre dos secuencias, para luego extender estas coincidencias. BLAST provee cuatro tipos de algoritmos para alineamientos, los cuales se diferencian en los archivos de entrada y salida:

 Programa | Database (subject) | Secuencia consulta (query)
 ------------ | ------------ | ------------
blastn  | ADN/ARN | ADN/ARN
blastp  | Proteína   | Proteína
blastx  | Proteína   | ADN/ARN (es traducido a proteína)
tblastn | ADN/ARN (es traducido a proteína) | Proteína
tblastx | ADN/ARN (es traducido a proteína) | ADN/ARN (es traducido a proteína)

Se puede instalar blast vía conda:
```bash
conda install -c bioconda blast
blastn -help
```

Dependiendo de la herramienta de blast que se utilice será el comando a ejecutar, pero siempre se debe indicar el archivo con las secuencias, consulta con `query`, la base de datos o archivo con los que se alineará la secuencia, consulta y el archivo que almacenará la salida con `out`. A continuación se presenta una ejecución básica utilizando las cuatro herramientas indicadas:
```bash
blastn  -query query.fasta -subject subject.fasta  -out results.out
blastn  -query query.fasta -db database -out results.out 
blastp  -query query.fasta -subject subject.fasta  -out results.out
tblastn -query query.fasta -subject subject.fasta  -out results.out
blastx  -query query.fasta -subject subject.fasta  -out results.out
```

Se pueden encontrar todos los parámetros de blast en su documentación oficial ([Documentación parámetros](https://www.ncbi.nlm.nih.gov/books/NBK279684/)). A continuación se presentan los parámetros más útiles a conocer:
- `-db`: Nombre de la base de datos a consultar.
- `-query`: Archivo con secuencias de consulta.
- `-evalue`: Valor de E-value esperado. Si un alineamiento posee un E-value mayor a este valor, se descartará el alineamiento.
- `-out`: Nombre del archivo de salida.
- `-num_alignments`: Número máximo de alineamientos reportados (para `outfmt` <= 4)
- `-max_target_seqs`: Cantidad máxima de alineamientos a mantener.
- `-html`: Producir un archivo de salida en formato `html`.
- `-num_threads`: Número de cores a utilizar al ejecutar blast.
- `-outfmt`: Modificar la forma de visualizar el archivo de salida. Debemos indicarle el tipo de visualización que queremos, siendo las más utilizadas la forma tabular (opción 6). Más información de los tipos de visualizaciones disponibles en la [documentación](([Documentación parámetros](https://www.ncbi.nlm.nih.gov/books/NBK279684/)))

Por defecto, el output de blast es en formato pairwise. Un parámetro útil a utilizar es `-outfmf 6` el cual organiza la salida de blast de forma tabular. El formato `outfmt` cuenta con los siguientes campos:
- `qseqid`: ID de la secuencia consulta (query).
- `sseqid`: ID de la secuencia de consulta (subject).
- `pident` Porcentaje de coincidencias idénticas.
- `length`: Tamaño o longitud de alineamiento (overlap entre ambas secuencias)
- `mismatch`: Número de mismatch.
- `gapopen`: Número de gaps introducidos.
- `qstart` Posición de inicio del alineamiento en la secuencia consulta.
- `qend`: Posición de fin de alineamientos en la secuencia consulta.
- `sstart`: Posición de inicio del alineamiento en la secuencia de la base de datos.
- `send`: Posición de fin del alineamiento en la secuencia de la base de datos.
- `evalue`: Valor esperado, se define como el número de aciertos que podrían encontrarse por casualidad.
- `bitscore`: Puntaje normalizado del alineamiento.
- `qlen`: Longitud de la secuencia query.
- `slen`: Longitud de la secuencia de la base de datos.
- `gaps`: Número total de gaps.
- `qseq`: Parte de la secuencia query que fue alineada.
- `sseq`: Parte de la secuencia objetivo que fue alineada.
- `staxids`: Id de la secuencia de la base de datos (con la que hizo match la query).
- `sscinames`: Nombre científico de la secuencia de la base de datos (con la que hizo match la query).
- `scomnames`: Nombre común de la secuencia de la base de datos (con la que hizo match la query).
- `sblastnames`: Subject Blast Name(s), separated by a ';' (in alphabetical order)
- `sskingdoms`: Reino al que pertenece la secuencia de la base de datos (con la que hizo match la query).
- `qcovs`: Cobertura del alineamiento.

Podemos utilizar la opción 6 para que imprime solo 12 columnas (`qseqid sseqid pident length mismatch gapopen qstart qend sstart send evalue bitscore`).  O también podemos indicar en el comando que campos queremos que se mustren en el archivo de salida.
```bash
blastn -query genes.fasta -subject genome.fasta -outfmt 6
blastn -query genes.fasta -subject genome.fasta -outfmt "6 qseqid sseqid evalue"
```

Pemos añadir más parametros en la ejecución de blast, como por ejemplo, el valor máximo de evalue permitido, o la cantidad máxima de alineamientos a mostrar en el archivo de salida.
```bash
blastn -db database -query seqs.fasta -out out.out -num_threads 6 -outfmt 6 -evalue 0.00001
```

##### Cómo interpretar los resultados de BLAST
BLAST entrega dentro de sus resultados múltiples métricas que sirven para evaluar el alineamiento obtenido. Dentro de esos, es importante considerar:
- E-value: es una medida estadística que indica qué tan probable es que el hit haya sido por casualidad, la cual tiene en consideración el tamaño de la base de datos. Un E-value de 10 significa que se esperan 10 hits por casualidad en una base de datos del mismo tamaño. Mientras menor sea el valor del E-value, más confiable es el hit dentro de la base de datos, generalmente se considera 0.01 un umbral para este valor.
- bit score: es una medida que indica la similitud entre las secuencias alineadas, la cual es independiente del tamaño de la secuencia y de la base de datos. Mientras más alto, mejor es el hit.

##### Consideraciones al utilizar BLAST
- Como entrada BLAST solo acepta archivos en formato `FASTA`, en caso de tener archivos `FASTQ` se debe utilizar alguna herramienta previa a la ejecución de BLAST para transformar el archivo `FASTQ` a `FASTA` (por ejemplo `seqkit`).
- La cantidad de cores a utilizar no implica una disminución exponencial en tiempo, se ha demostrado que utilizar como máximo 6-8 cores aumenta el rendimiento de forma considerable, pero al utilizar más que los indicados anteriormente no veremos una mayor disminución en tiempo.

##### Bases de datos de NCBI
[Documentación](https://www.ncbi.nlm.nih.gov/books/NBK62345/) || [FTP](https://ftp.ncbi.nlm.nih.gov/blast/db/)
NCBI cuenta con un conjunto de bases de datos ya procesadas y listas para ser utilizadas por Blast. Algunas de las más relevantes a conocer son la base de datos de `16S Ribosomal RNA`, `18S y 28S Fungal`, `Betacoronavirus`, `ITS`, `Genoma Humano`, `Genoma de ratón` y `nt y nr`.

También podemos encontrar un archivo llamado `taxdb.tar.gz` el cual contiene información taxonómica, proporciona los nombres comunes y científicos para cada secuencia, lo cual puede ser información bastante útil a la hora de visualizar el archivo de salida de Blast.

Podemos descargar estas bases de datos directamente desde el FTP de NCBI o utilizar el comando `blastdbcmd` para descargarlas mediante línea de comando. Podemos utilizar el comando `update_blastdb`para actualizar alguna base de datos existente.

##### Crear base de datos
En caso de ser necesario, podemos generar nuestra propia base de datos personalizada a partir de secuencias de interés. Para ello necesitamos utilizar el comando `makeblastdb`y contar con el archivo en formato `fasta` que contenga las secuencias a utilizar en la base de datos, debemos también indicarle a  blast que tipo de base de datos estamos creando (proteínas o nucleotidos), y finalmente indicar el nombre de la base de datos:
```bash
makeblastdb –in mydb.fsa –dbtype "nucl" –out db_nucleotides
makeblastdb –in mydb.fsa –dbtype "prot" –out db_proteins
```

Al crear la base de datos veremos un conjunto de archivos en formato binario `.phr`, `.pin`, y `.psq`

La ventaja de transformar nuestros archivos al formato de base de datos de Blast, es que al analizar conjuntos de datos grandes, la velocidad de los análisis y comparaciones será mucho más rápida.

