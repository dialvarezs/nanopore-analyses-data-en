Temas a abordar:
- Tipos de alineamientos
- Herramientas para realizar alineamientos
- Herramientas para visualizar alineamientos

## Conceptos generales
Un alineamiento tiene por objetivo el comparar múltiples secuencias e identificar similitudes entre ellas. En base a estos alineamientos se pueden obtener resultados como la existencia de relaciones evolutivas o funcionales, presencia de variantes, entre otras

Cuando se analiza la composición de un alineamiento, existen ciertos conceptos que definen el resultado obtenido:
- match: Coincidencia de bases en la posición comparada.
- indel: Inserción o eliminación de un base en una posición determinada. Los indels son representados con gaps (utilizando el símbolo `-`), y son representados en la secuencia a la que le "faltan" las bases que posee la otra.

Existen diferentes tipos de alineamientos dependiendo la cantidad de secuencias que se comparen, los cuales son:
- Alineamiento pareado: Involucra dos secuencias.
- Alineamiento múltiple: Involucra más de dos secuencias.

![[alineamiento_2.png]]

## Alineamiento pareado
Herramientas: Water, Needle

El alineamiento pareado es la forma más básica de realizar un alineamiento y solamente involucra dos secuencias. Los alineamientos de este tipo son sencillos de interpretar, por lo que se suelen visualizar directamente con una representación en la que se muestran ambas secuencias indicando los matches entre ambas secuencias.
![[alineamiento_3.png|550]]

En algunos casos, las secuencias a alinear puede tener solamente ciertas partes en común (por ejemplo, si se trata de diferentes organismos que tienen un alto nivel de similitud). Por esta razón existen dos tipos de alineamiento pareado: el local y el global.
![[alineamiento_1.png]]

### Alineamiento local
Al hacer un alineamiento local solamente se considera la sección que tenga mayor similitud entre ambas secuencias, aunque no se abarque la totalidad de las secuencias (las partes que no son similares son excluidas del alineamiento e "ignoradas").

Para realizar un alineamiento local, se puede utilizar la herramienta "Water", la cual se puede utilizar en línea a través de [este enlace](https://www.ebi.ac.uk/Tools/psa/emboss_water/).
![[pairwise_local.png]]

### Alineamiento global
A diferencia del alineamiento local, el alineamiento global exige que se utilicen ambas secuencias en su totalidad, por lo que abarca ambas secuencias de principio a fin.

Para realizar un alineamiento local, se puede utilizar la herramienta "Neddle", la que se puede usar en línea a través de [este enlace](https://www.ebi.ac.uk/Tools/psa/emboss_needle/).
![[pairwise_global.png]]

## Alineamiento múltiple
Herramientas: Clustal Omega, MAFFT

Un alineamiento múltiple de secuencias (MSA por su sigla en inglés) es un tipo alineamiento 
diseñado para comparar una gran cantidad de secuencias que tienen un alto nivel de similitud entre sí. A partir de un alineamiento múltiple se puede obtener información sobre dominios conservados y/o variables, presencia de SNP, entre otras cosas.

#### Clustal Omega
[Página oficial](http://www.clustal.org/omega/) || [Herramienta web](https://www.ebi.ac.uk/Tools/msa/clustalo/) 

Clustal Omega es una herramienta que permite realizar alineamiento múltiple de secuencias (MSA) que generalmente se utiliza con proteínas, pero también se puede utilizar con secuencias de ADN y ARN.

Instalación (conda).
```bash
conda install -c bioconda clustalo

clustalo --version 
clustalo --help
```

Clustal Omega requiere como mínimo indicar el archivo de entrada y de salida. Adicionalmente, se puede indicar el formato de salida con la opción `--outfmt` (el formato por defecto es FASTA).
```bash
clustalo --in=input.fasta --out=output.fasta
```

### Visualización de alineamientos múltiple

#### Aliview
[Página oficial](https://ormbunkar.se/aliview/) || [Repositorio](https://github.com/AliView/AliView)

Aliview permite visualizar alineamientos múltiples en formato FASTA y otros. Se puede descargar de su [página web](https://ormbunkar.se/aliview/#DOWNLOAD), y está disponible para Windows, MacOS y Linux. Permite destacar variaciones entre las secuencias y traducir las secuencias de DNA a aminoácidos, entre otras opciones.

Para cargar un archivo se debe utilizar la opción `Open File` que está en el menú `File`, y luego pueden utilizarse las opciones en menú `View` para habilitar opciones adicionales de visualización.
![[aliview.png]]

## Alineamiento contra referencia
Herramientas: Minimap2, BWA, Bowtie2, HISAT2, STAR

El alineamiento contra una referencia (también llamado mapeo), es un tipo de alineamiento donde todas las lecturas son comparadas contra una referencia, y que utilizan herramientas específicamente diseñadas para este fin, las cuales destacan por su eficiencia y velocidad. El alineamiento contra referencia es el proceso previo a muchos tipos de análisis, como la identificación de variantes o los análisis de expresión génica.

En el alineamiento contra referencia se asume que la referencia es la secuencia "correcta", y las lecturas son adaptadas para que se "encuadren" la referencia, mediante la introducción de inserciones y deleciones. El proceso es independiente para cada lectura, por lo que en ningún momento se consideran las demás lecturas al mapear una lectura especfíca (a diferencia del alineamiento múltiple).
![[reference_mapping.png]]

La mayoría de las herramientas están diseñadas para trabajar con reads cortos (debido a que estas tecnologías son las más adecuadas para obtener alta profundidad), pero hay algunas más flexibles, como Minimap2.

#### Minimap2
[Repositorio](https://github.com/lh3/minimap2)

Minimap2 permite realizar alineamientos contra referencia, soporta lecturas cortas, pero también lecturas Oxford Nanopore y PacBio. También puede encontrar superposiciones en lecturas largas con hasta un 15% de error, alinear ensamblajes y genomas completos relacionados, entre otras características.

Instalación (con conda).
```bash 
conda install -c bioconda minimap2

minimap2 --version
minimap2 --help
```

Minimap2 utiliza el mismo algoritmo base para todas las aplicaciones de alineamientos que soporta, por lo que incluye un conjunto de "presets" que configuran los parámetros para los casos específicos, los que se pueden seleccionar con la opción `-x`. Es importante seleccionar el preset adecuado para el experimento que se desee realizar, ya que de lo contrario los resultados no serán los óptimos. Los presets disponibles son los siguientes:
- `map-ont`: Mapeo de lecturas Nanopore contra una referencia.
- `map-pb`: Mapeo de lecturas PacBio CLR contra una referencia.
- `map-hifi`: Mapeo de lecturas PacBio HiFi contra una referencia.
- `ava-ont`: Búsqueda de superposiciones en lecturas Nanopore
- `ava-pb`: Búsqueda de superposiciones en lecturas provenientes de PacBio
- `asm5/asm10/asm20`: Mapeo de ensamblaje contra una referencia. Se puede indicar el porcentaje de divergencia (asm5: 0.1%, asm10%: 1, asm20: 5%)
- `sr`: Mapeo de lecturas cortas.

Por defecto, Minimap2 entrega los alineamientos en formato PAF, los cuales se pueden manipular con la herramienta `paftools.js` (incluida en Minimap2), pero también se puede utilizar el parámetro `-a` para indicar que queremos el output en formato SAM. El parámetro `--threads` o `-t` permite indicar cuantos threads queremos utilizar al ejecutar el comando.

Se puede realizar un alineamiento de múltiples secuencias, como por ejemplo una raw data de secuenciación contra una referencia.
```bash
minimap2 -ax map-ont ref.fa ont-reads.fq > aln.sam
```

También se puede realizar un alineamiento de un ensamblaje con una referencia, indicando una divergencia de un 0.1%:
```bash
minimap2 -ax asm5 ref.fa asm.fa > aln.sam
```

O buscar solapamientos entre lecturas largas: 
```bash
minimap2 -x ava-ont reads.fq reads.fq > ovlp.paf
minimap2 -ax ava-ont ROH.fastq ROH.fastq -t 4 > ROH.sam 
```

Se puede también realizar un alineamiento de una referencia contra lecturas cortas.
```bash
minimap2 -ax sr ref.fa R1.fa R2.fa > aln_short_reads.sam
```

Para visualizar alineamientos o utilizarlos como input en otras herramientas se requiere transformar los alineamientos a formato `bam` y ordenarlos por coordenadas genómicas. Generaremos también un índice para nuestro archivo `.sorted.bam` debido a que es requerido por algunos programas. Para esto utilizaremos samtools.

```bash
samtools view seq.sam --threads 4 -o seq.bam --bam
samtools sort seq.bam -o seq.sorted.bam
samtools index seq.sorted.bam seq.sorted.bam.bai
```


### Visualización de alineamientos contra referencia

#### Tablet
[Página oficial](https://ics.hutton.ac.uk/tablet/) || [Documentación](http://tablet.hutton.ac.uk/en/latest/)

Tablet es una herramienta desarrollada para la visualización y exploración de ensamblajes de secuencias. Tablet acepta como entrada los formatos  `ACE`, `AFG`, `BAM`, `MAQ`, `SAM` o archivos en formato `SOAP2` . Si se utilizan archivos `bam` como entrada deben estar ordenados por coordenadas genómicas e indexados.

Se puede instalar mediante los instaladores presentes en su página oficial, e igual está disponible para instalar mediante conda. Dado que es un programa con interfaz gráfica, no sirve instalar esta herramienta en un servidor que únicamente se puede utilizar mediante línea de comandos.

En la pantalla principal de tablet podremos visualizar las lecturas alineadas con la referencia. Se puede visualizar también la traducción a proteína y al pulsar encima de la lectura se visualiza información general. Al navegar en el panel superior podremos personalizar algunas opciones de visualización como por ejemplo el esquema de colores, permitiéndonos visualizar el alineamiento coloreado según el nucleótido a visualizar, o según el tamaño de la lectura, o destacando aquellas bases que presenten una discordancia con la referencia.

![[align_tablet.png]]

### Manipulación de archivos SAM/BAM

#### Samtools
[Repositorio](https://github.com/samtools/samtools) || [Documentación](http://www.htslib.org/doc/samtools.html)

Samtools es un conjunto de herramientas que permiten interactuar con datos de secuenciación. Está compuesto de tres repositorios:
- Samtools: Manipulación de archivos SAM/BAM/CRAM (lectura, escritura, edición, indexar/ formato 
- BCFtools: Manipulación de archivos BCF2/VCF/gVCF (lectura, escritura, manejo y resumen de SNP e indels)
- HTSlib: Biblioteca escrita en C para lectura y escrtura de datos de secuenciación de alto rendimiento.
- Tanto Samtools como BCFtools utilizan internamente HTSlib.

Durante este taller veremos diferentes comandos de Samtools que nos permitirá manipular archivos SAM, BAM y CRAM. 

##### Convertir archivos SAM a archivos BAM
Para convertir archivos SAM a su equivalente binario utilizaremos el comando `view` de `samtools`. Se debe especificar el archivo de entrada, como el nombre del archivo de salida, junto con la opción `--bam` para indicar que este es el formato de salida. Se puede además indicar la cantidad de threads a utilizar.

```bash
samtools view seq.sam -o seq.bam --bam --threads 4
```

##### Ordenar archivos de alineamientos
Al realizar alineamientos, estos se producen en forma aleatoria, por lo cual se hace necesario para muchos programas reordenar estos alineamientos en base a sus posiciones genómicas. Para esto utilizamos el comando `sort`.

```bash
samtools sort seq.bam -o seq.sorted.bam
samtools index seq.sorted.bam seq.sorted.bam.bai
```

##### Indexación de archivos
Se pueden indexar los archivos con el objetivo de extraer la información de manera más rápida. Esto genera nuevos archivos de indexado en formato `bai` por defecto o `csi`.

```bash
samtools index seq.sorted.bam seq.sorted.bam.bai
```

##### Extraer alineamientos
Se pueden extraer todos los alineamientos en una posición en específico con el comando `view`.

```bash
samtools view seq.sorted.bam 1:33000000-34000000
samtools view seq.sorted.bam 1:33000000-34000000 | wc -l
```

O también contar el número total de alineamientos: 

```bash
samtools view seq.sorted.bam | wc -l
```

##### Obtención de profundidad
Se puede obtener la cantidad de alineamientos en cada posición de nuestro alineamiento con el comando `depth`. 
```bash
samtools depth -a seq.sorted.bam -o output.depth
```

##### Obtención de estadísticas básicas
Se puede obtener un archivo tabulado con las principales características del alineamiento con el comando `coverage` (cantidad de lecturas, porcentaje de bases cubiertas, cobertura,  profundidad promedio, calidad promedio)
```bash
samtools coverage seq -o output.coverage
```