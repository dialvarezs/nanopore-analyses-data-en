Temas a abordar:
- Como realizar un control de calidad con herramientas como Fastqc y Nanoplot y entender los resultados que entregan las herramientas.
- Como resumir las estadísticas para un conjunto de muestras
- Como filtrar nuestros datos con herramientas como Fastp y Cutadapt

## Control de calidad
El procesamiento y análisis de los datos de secuenciación (raw data) es un proceso crítico a la hora de realizar análisis posteriores, es por esto que es de suma importancia realizar un control y filtro de datos antes de cualquier análisis bioinformático.


#### Calidad
Se debe recordar que todos los archivos `fastq` contienen la información de calidad de las secuencias codificada con símbolos ASCII.

![[fq.png]]

Para poder entender la codificación de calidad se puede visualizar la tabla de equivalencia de Q-score - ASCII, recordando siempre que los Q-scores representan la probabilidad de error asociada a un nucleótido dentro de una secuencia.

![[illumina_fastq_coding.png]]

Para calcular la probabilidad de que la base sea incorrecta se utiliza la fórmula   `10^(-Q/10)`

Phread Quality Score |Probabildad de una base incorrecta | Exactitud 
------------ | ------------ | ------------
10 | 1 en 10 | 90%
20 | 1 en 100 | 99%
30 | 1 en 1000 | 99,9%
40 | 1 en 10000 | 99,99%


#### FastQC
[Repositorio](https://github.com/s-andrews/FastQC) || [Página oficial](https://www.bioinformatics.babraham.ac.uk/projects/fastqc/) || [Documentación](https://dnacore.missouri.edu/PDF/FastQC_Manual.pdf)

FastQC es una herramienta que permite obtener de forma sencilla métricas de control de calidad de datos de secuenciación. Puede recibir como input archivos `.fastq`, como también archivos de alineamientos `.bam` o `.sam`. Genera un reporte en formato HTML que está compuesto de múltiples módulos, dónde cada uno tendrá un estado de Aprobado/Fallido/Advertencia dependiendo de como se encuentren los datos. Estos estados pueden estar sujetos a interpretación, ya que su definición se basa en umbrales definidos para ciertos conjuntos de datos, como lo son datos de Whole Genome Sequencing, y plataformas de secuenciación que poseen una calidad alta. Debido a esto es que es común que al utilizar tecnologías de secuenciación como Nanopore, es normal encontrarse con algunos módulos fallidos con "fallas". Por esta razón es relevante tener en cuenta la naturaleza de los datos secuenciados y la plataforma de secuenciación al evaluar estos resultados.

Los módulos presentes en FastQC son los siguientes:
- **Estadísticas básicas:** Información básica sobre el archivo de entrada (número total de secuencias, longitud mínima y máxima de las secuencias, contenido GC promedio, tipo de codificación de calidad).
- **Calidad de la secuencia por base:** Gráfico que presenta en el eje X la posición de la secuencia y en el eje Y la calidad. Adicionalmente contiene un diagrama de caja y bigotes donde
	- La línea central roja presenta el valor de la mediana
	- La caja presenta el rango inter cuartil (25% - 75%)
	- Los bigotes representan el 10% y 90%
	- La línea azul representa la calidad de la media.
* **Calidad por secuencia:** Número total de lecturas por cada puntuación de calidad promedio (en el eje X se representa la calidad y en el eje Y la cantidad de secuencias).
* **Contenido de base por secuencia:** Se indica la proporción de cada base a lo largo de la secuencia. Cada color representa una base como se indica en la leyenda del gráfico.
* **Contenido GC por secuencia:** Cantidad de lecturas por el porcentaje de GC promedio (el eje X representa el porcentaje de contenido GC, mientras que el eje Y representa la cantidad de secuencia).
* **Contenido de N's por base:** Porcentaje de bases sin asignar por cada posición.
* **Distribución de tamaño por secuencia:** En el eje X se representa el largo de la lectura y en el eje Y la cantidad de lecturas.
* **Nivel de duplicación de secuencias:** Porcentaje de lecturas que están presentan un número determinado de veces. El eje X representa la cantidad de veces que aparece una secuencia distinta, mientras en el eje Y el porcentaje. Para el eje X, el número 1 representa secuencias singletons (secuencias que aparecen una sola vez), el número 2 representa el número de secuencias que aparecen dos veces (por cada doble se contará solo una vez), el número 3 representa el número de secuencias en tripletes, es decir, que aparecen 3 veces y así sucesivamente. La línea azul representa el recuento de todas las secuencias que se deduplican un número determinado de veces en base al total de las secuencias, mientras que la línea roja representa lo mismo, pero tomando como base para el cálculo el número total de secuencias distintas. El porcentaje de deduplicación que se presenta en el título se calcula como todas aquellas secuencias distintas / total de secuencias * 100.
* **Secuencias sobrerepresentadas:** Este módulo analiza aquellas secuencias que se encuentran en la secuenciación en una proporción alta (mayor o igual al 0.1%). Las secuencias sobrerepresentadas en algunos casos indican contaminación o baja diversidad en la librería. Estas secuencias sobrerepresentadas se comparan con una base de datos de contaminantes comunes. Para este módulo solo se consideran las primeras 50 bases.
* **Contenido de adaptadores:** Gráfico acumulativo sobre la cantidad de lecturas que presentan adaptadores. FastQC maneja un conjunto de adaptadores específicos de Illumina, Nextera y Solid.

Se puede instalar FastQC vía conda:
```bash
conda install -c bioconda fastqc
```

Para verificar  que la herramienta se haya instalado correctamente se puede visualizar la versión de la herramienta, y su ayuda
```bash
fastqc --version
fastqc --help
```

Una ejecución básica de FastQC solo requiere el archivo de entrada, pero se puede también indicar la cantidad de threads a utilizar para optimizar la ejecución del programa, y también indicar el directorio donde se van a guardar los resultados (debe estar creado antes de ejecutar el comando).
```bash
fastqc <archivo.fastq>
fastqc <archivo.fastq> --outdir <reporte_fastqc> --threads 4
```

Existen diferentes parámetros que se le pueden indicar al comando, como el tamaño mínimo de las secuencias que se mostrarán en el reporte (`--min_length`), definir un archivo con contaminantes para ser utilizado en el análisis de secuencias sobrerepresentadas (`--contaminants`), o indicar uno archivo con adaptadores específicos para ser buscados en las secuencias (`--adapters`), entre otras. Todos los parámetros se encuentran definidos en la ayuda y en la documentación oficial.

También se puede abrir una interfaz gráfica del programa fastqc y cargar el archivo desde la interfaz y visualizarlo en el mismo programa.

_NOTA:_ Cabe destacar que el directorio indicado mediante el parámetro `--outdir` debe existir antes de la ejecución del comando. Para crear  nuevos directorios se puede utilizar el comando `mkdir` y el nombre del directorio a crear.

#### Nanoplot
[Repositorio](https://github.com/wdecoster/NanoPlot) 

Nanoplot es una herramienta que permite generar un reporte de calidad para datos provenientes de tecnologías de lecturas largas. Existe una versión web de esta herramienta, pero está limitada a archivos de entrada de máximo 100MB ([Nanoplot](http://nanoplot.bioinf.be)).

Se puede instalarlo vía conda
```bash
conda install -c bioconda nanoplot
```

Para acceder a la ayuda de NanoPlot se utiliza el parámetro `--help`, y a la versión con la opción `--version`.
```bash
NanoPlot --help
NanoPlot --version
```

Una ejecución básica de Nanoplot solo requiere el archivo de entrada, pero se puede indicar la cantidad de threads a utilizar, y el directorio donde se van a guardar los resultados (en caso que no se indique el directorio, los reportes y gráficos generados se van a almacenar en el mismo directorio de ejecución).
```bash
NanoPlot --fastq bc02.fq --outdir bc02 
```

Se puede también indicar tamaños mínimos y máximos de las secuencias a considerar, o un prefijo a utilizar en los archivos de salida. También se puede utilizar como archivo de entrada el archivo resumen obtenido en la secuenciación (`sequencing_summary`) en lugar de un archivo `fastq` o `bam`.
```bash
NanoPlot --threads 4 --fastq bc02.fq --outdir bc02 --minlength 1000 --maxlength 2000 --prefix bc02
NanoPlot --summary sequencing_summary.txt --outdir sequencing_data
```

NanoPlot genera un reporte en formato HTML, pero también un reporte resumido en formato texto, y gráficos interactivos. Se puede visualizar en su reporte una sección de estadísticas, compuesta por información de longitud de las secuencias, de calidad, cantidad de lecturas y total de bases.  Además se puede visualizar un resumen de cantidad de secuencias con calidad mayor a 5, 7, 10, 12 y 15, y un resumen de las lecturas más largas y su calidad, y viceversa. 

También se puede visualizar un conjunto de gráficos interactivos, a los cuales se le puede hacer zoom o seleccionar rangos de interés. La mayoría de los gráficos se enfocan en la visualización de la longitud de las lecturas versus la cantidad o calidad de las lecturas.

#### MultiQC
[Documentación](https://multiqc.info/docs) 

MultiQC es una herramienta que permite agrupar múltiples reportes de métricas de calidad generadas por diversas herramientas bioinformáticas, lo cual es particularmente útil al querer visualizar múltiples muestras y/o pasos del análisis bioinformático en un único lugar. MultiQC busca dentro del directorio proporcionado a través de la línea de comando (considerando también sus subdirectorios), extrae la información relevante de los reportes encontrados y la compila en un único reporte en formato HTML.

MultiQC está pensando para funcionar principalmente con archivos provenientes de la herramienta `fastqc`, pero desde hace un tiempo que se han implementado diferentes módulos para poder trabajar con resultados obtenidos de diferentes herramientas como `fastp`, `cutadapt`, `NanoPlot`, `jellyfish`, entre otros. Para más información sobre los módulos disponibles, visitar la documentación oficial ([MultiQC modules](https://multiqc.info/docs/#multiqc-modules)). 

Se puede instalar MultiQC vía conda y verificar su versión y ayuda: 
```bash
conda install -c bioconda multiqc

multiqc --help
multiqc --version
```

A continuación se presentan tres ejemplos de ejecución de la herramienta MultiQC. En el segundo ejemplo se especifica utilizar el módulo `nanostat` para trabajar con archivos provenientes de `NanoPlot`.
```bash
multiqc <path_to_fastqc_results>
multiqc <path_to_NanoStats_out.txt> --module nanostat
multiqc <path_to_fastqc_results> --filname multiqc_raw_data
```

## Calidad en Nanopore
![[nanopore_qscore.png]]


## Filtros de calidad
#### Fastp
[Repositorio oficial](https://github.com/OpenGene/fastp)

Fastp es una herramienta para procesar archivos en formato fastq. Permite recortar adaptadores, filtrar por calidad, recortar extremos por calidad o por posición determinada, filtrar lecturas por largo mínimo y  máximo, entre otras características.

Se puede instalar fastp vía conda y verificar su versión y ayuda:  
```bash
conda install -c bioconda fastp

fastp --help
fastp --verson
```

Se puede indicar a fastp archivos provenientes de secuenciaciones Single end, o también pasarle ambos archivos al utilizar secuenciación Pair End. Dos ejemplos sencillos de ejecución utilizando los parámetros por defecto con diferentes tipos de secuenciaciones sería:
```bash
fastp -i seq.fastq -o seq_filtered.fastq  # Single end data
fastp --in1 in.R1.fq.gz --in2 in.R2.fq.gz --out1 out.R1.fq.gz --out2 out.R2.fq.gz  # Pair end data
```
El ejemplo anterior utilizaría los filtros por defecto de Fastp (calidad apta de Q15, detectar adaptadores para Illumina, tamaño mínimo de 15pb, etc.), por lo que hay que tener cuidado y verificar que los filtros por defecto sean acorde a los filtros que queremos realizarle a nuestros datos.

Fastp utiliza por defecto un método de filtrado de reads en el que se determina si un read pasa o no el filtro considerando si un determinado porcentaje de sus bases cumple con cierta calidad. Por defecto, se requiere que un 60% de las bases posean calidad igual a superior a Q15.
Igualmente, es posible cambiar el método a uno basado en la calidad media del read (con la opción `-e`).

Algunos parámetros a tener en consideración a la hora de utilizar Fastp:
* `--disable_quality_filtering (-Q)`: Deshabilita el filtro por defecto de calidad de fastp.
* `--qualified_quality_phred (-q)`: Para indicar la calidad mínima para que una base se considere con calidad apropiada (por defecto 15).
* `--average_qual (-e)`: Calidad mínima promedio para que una secuencia sea considerada como apta.
* `--unqualified_percent_limit (-u)`: Porcentaje permitido de bases que no pasen el corte de calidad (por defecto 40%).
* `--disable_adapter_trimming (-A)`: Desactivar filtro de adaptadores por defecto (adaptadores de secuenciaciones Paired End y Single End de Illumina).
* `--adapter_fasta`: En caso de deshabilitar el filtro de adaptadores por defecto, se puede indicar un archivo que posea los adaptadores de nuestra secuenciación y pedirle que los elimine.
* `--length_required`: Se puede indicar un largo mínimo y descartar todas aquellas lecturas que tengan un tamaño menor al indicado (por defecto es 15bp).
* `--length_limit`: Se puede indicar un largo máximo, y descartar todas aquellas lecturas que tengan un tamaño mayor al indicado.
* `--cut_front`: Eliminar las bases al comienzo de la secuencia (5') que tengan una calidad promedio menor a la indicada con ` cut_mean_quality`. Se utiliza una ventana de 4pb para hacer los cálculos de calidad promedio (modificable mediante `cut_window_size`).
* `--cut_tail`: Eliminar las bases al final de la secuencia (3') que tengan una calidad promedio menor a la indicada con ` cut_mean_quality`.
* `--cut_mean_quality`: Calidad mínima utilizada para recortar los extremos de la secuencia por calidad promedio (al utilizar parámetros como `cut_front`, `cut_tail`) (por defecto Q20).
* `--trim_front`: Recortar una cantidad fija de bases al comienzo de la secuencia (5').
* `--trim_tail`: Recortar una cantidad fija de bases al final de la secuencia (3').
* `--max_len`: Si la lectura es mayor al tamaño indicado, recortar las bases restantes en 3'.
* `--disable_trim_poly_g`: Por defecto fastp elimina las colas polyG que encuentre, esta opción permite deshabilitar esta caracteristica.

A continuación se muestran ejemplos de ejecución utilizando parámetros personalizados: 
```bash
fastp -i <archivo_fastq> -o <arhivo_output> --html fastp_report.html \
  --disable_trim_poly_g --disable_adapter_trimming \
  --thread <número_de_cores> -q <calidad_mínima> \
  --length_required <tamaño_mínimo> \ 
  --length_limit <tamaño_máximo> \
  --cut_front \
  --cut_tail \
  --cut_mean_quality <calidad_minima>

fastp -i input.fastq -o output.fastq --html fastp_report.html \
  --disable_trim_poly_g --disable_adapter_trimming \
  --thread 6 -q 15 \
  --length_required 1000 \ 
  --length_limit 2000 \
  --cut_front \
  --cut_tail \
  --cut_mean_quality 12
```

Cabe destacar que `fastp` cuenta con muchas opciones más para realizar filtros y procesar archivos fastq, por lo que revisar su ayuda o documentación será de gran utilidad. 

Fastp entrega como resultado un reporte con la información general del archivo utilizado como input, e información relevante antes de realizar los filtros de calidad y luego de realizar los filtros de calidad. Esta información puede resumirse a través de MultiQC utilizando el módulo diseñado para trabajar con archivos provenientes de Fastp (`fastp`).

#### Cutadapt
[Repositorio oficial](https://github.com/marcelm/cutadapt) ||  [Documentación](https://cutadapt.readthedocs.io/en/stable/)

Cutadapt permite encontrar y eliminar adaptadores, secuencias de cebadores, colas polyA, entre otras secuencias no deseadas, teniendo en consideración cierta tolerancia a errores. Además, es posible utilizarlo para demultiplexar con códigos de barra propios, modificar y filtrar secuencias de varias maneras.

Se puede instalarlo vía conda y verificar su versión y ayuda:  
```bash
conda install -c bioconda cutadapt
cutadapt --help
cutadapt --verson
```

 Algunos parámetros útiles a conocer para detectar adaptadores o barcodes con `cutadapt` se listan a continuación:
- `--front (-g)`: Buscará y eliminará el adaptador indicado solo en el extremo `5'`. En caso de añadir el símbolo `^` al final del adaptador o del archivo, se buscará el adaptador como sufijo.
- `--adapter (-a)`: Buscará y eliminará el adaptador indicado solo en el extremo `3'`. En caso de añadir el símbolo `$` al final del adaptador o del archivo, se buscará el adaptador como sufijo.
- `--anywhere (-b)`: Buscará y eliminará el adaptador indicado en ambos extremos (`3'` y `5'`).
- `--error-rate (-e)`: Máximo rango de error permitido al buscar adaptadores (por defecto: 0.1 (10%)).
- `--no-indels`: Al buscar los adaptadores solo permitirá mismatches en el alineamiento y no inserciones ni eliminaciones.
- `--cores (-j)`: Cantidad de cores a utilizar (por defecto 1).

En el caso de tener secuencias provenientes de Illumina, con secuenciación paired-end se puede utilizar los parámetros `-A`, `-G` y `-B` para identificar adaptadores en el archivo `R2`.

En caso de utilizar barcodes no nativos de Oxford Nanopore, se puede demultiplexar con `cutadapt` indicándole las secuencias que debe buscar para clasificar las lecturas.
```bash
cutadapt -a bc01=TATA -a bc02=GCGC -o trimmed-{name}.fastq.gz sequences.fastq.gz
```

El comando anterior generará tres archivos llamados `trimmed-bc01.fastq.gz`,  `trimmed-bc02.fastq.gz` y un archivo donde se almacenan aquellas secuencias que no se pudieron demultiplexar `demulti-unknown.fastq.gz`.

También se puede indicar a `cutadatp` un archivo `fasta` que contenga las secuencias a utilizar. A continuación se presenta un ejemplo de archivo de barcodes:
```bash
>barcode01
TTAAGGCC
>barcode02
TAGCTAGC
>barcode03
ATGATGAT
```

Para demultiplexar debemos indicar el archivo de barcodes, mediante el parámetro  `-g` se indica los barcodes en 5' y con `-a` los barcodes en 3'. La opción `-e` permite indicarle cuanto porcentaje de error se va a permitir al buscar los barcodes en las secuencias. El parámetro `-o` permite indicar el nombre con el que se almacenarán los archivos demultiplexados, `{name}` indicará el nombre del barcode (identificador en archivo `fasta`).
```bash
cutadapt -e 0.15 \
 -g ^file:barcodes_front.fasta \
 -a  file:barcodes_rev.fasta$ \
 -o "trimmed-{name}.fastq.gz" \
 --cores 4 \
 input.fastq.gz
```

También se puede utilizar el parámetro `-a` para indicar un patrón de adaptadores a eliminar y obtener solamente la secuencia de interés limpia. 
```bash
cutadapt -a ^AGAGTTTGATCCTGGCTCAG...GGTTACCTTGTTACGACTT$ -o seq_cutadapt.fastq seq.fastq
```

Cutadapt también permite realizar filtro de secuencias mediante los siguientes parámetros:
- `--quality-cutoff <5’ cutoff,3’ cutoff>' (-q) `: Recorta bases de baja calidad en ambos extremos. Si un solo valor es indicado se recortarán las bases en el extremo `3'`.
- `--minimum-length`: Elimina las lecturas que tengan un tamaño menor al indicado.
- `--maximum-length`: Elimina las lecturas que tengan un tamaño mayor al indicado.
- `--max-n`: Elimina aquellas lecturas que contengan un porcentaje de `N's` mayor al indicado. 
- `--trim-n`: Elimina las `N` al final de la lectura.
- `--cut (-u)`: Recorta la cantidad de bases indicadas en cada lectura. Si el valor es positivo, se recortarán al inicio de la lectura, si es negativo, se recortarán al final de la lectura.

El siguiente ejemplo permite recortar las primras cinco bases en todas las lecturas, eliminar aquellas que tengan un tamaño menor a 1000,  y remover aquellas bases con calidad menor a 15 en el extremo 5' y menor a 10 en el extremo 3'.
```bash
cutadapt \
--cut 5 \
-q 15,10 \
--minimum-length 1000 \
-o trimmed.fastq reads.fastq
```


Tarea: Realizar control de calidad y filtros de calidad a datos de genoma completo. Se espera obtener los siguientes reportes:
	- Reporte `multiqc` obtenido con `fastqc` (antes y después de filtros)
	- Reporte `multiqc` obtenido con `NanoPlot` (antes y después de filtros)
	 - Reporte `multiqc` de filtrado con `fastp` 
	- Calcular la profundidad post filtros
	- Indicar si los datos son adecuados para realizar ensamblaje de genoma (justificar brevemente)
	- Reporte técnico con detalles de las versiones de las herramientas, filtros aplicados y comandos utilizados.
	- Idealmente juntar los 3 reportes de calidad en un solo reporte final de `multiqc`.


Cada estudiante deberá procesar los siguientes datos de secuenciación (`Documentos/data/Tarea_1`):
	- `AB`: Ivan Moya (150Kb)
	- `OA`: Pedro Simeone (17Kb)
	- `CA`: Estefania Jofré(150Kb)
	- `CB`: Carolina Pérez(150Kb)
	- `O2`: Alonso De la Rivera(17kb)
	
* Considerar que las secuencias no poseen adaptadores.

Fecha de entrega: 20/03/23
